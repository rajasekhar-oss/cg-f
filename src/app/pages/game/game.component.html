<app-error-notification *ngIf="showNotification" [message]="notificationMessage"
  (closed)="onNotificationClosed()"></app-error-notification>

<!-- Winner Stat Notification -->
<ng-container *ngIf="showWinnerStatNotification">
  <!-- Winner row (success background, no extra container) -->
  <ng-container *ngIf="!isTie" class="winner-stat-notification">
    <div class="winner-stat-notification" style="display: flex; align-items: center; background: var(--success-bg); ">
      <img *ngIf="winnerStatProfilePic" [src]="winnerStatProfilePic" class="winner-stat-profile-pic"
        alt="Winner profile" />
      <span class="winner-stat-username" *ngIf="winnerStatUsername"
        style="color: var(--success);">{{winnerStatUsername}}</span>
      <span class="winner-stat-label" style="color: var(--success);">{{winnerStatLabel}}:</span>
      <span class="winner-stat-value" style="color: var(--success);">
        {{winnerStatValue}}
        <img *ngIf="winnerStatCardImageUrl" [src]="winnerStatCardImageUrl" class="winner-stat-card-image"
          alt="Winner card" style="height: 32px; width: auto; margin-left: 8px; vertical-align: middle;" />
      </span>
    </div>
  </ng-container>
  <!-- Tie rows (warning background, each row separate, no big container) -->
  <ng-container *ngIf="isTie">
    <ng-container *ngFor="let tie of tieStatPlayers; let i = index">
      <div class="winner-stat-notification" [style.top.px]="i * 56" [style.background]="'var(--warning-bg)'">
        <img *ngIf="tie.profilePic" [src]="tie.profilePic" class="winner-stat-profile-pic" alt="Tie profile" />
        <span class="winner-stat-username" style="color: var(--warning);">{{tie.username}}</span>
        <span class="winner-stat-label" style="color: var(--warning);">{{winnerStatLabel}}:</span>
        <span class="winner-stat-value" style="color: var(--warning);">
          {{winnerStatValue}}
          <img *ngIf="tie.cardImage" [src]="tie.cardImage" class="winner-stat-card-image" alt="Tie card"
            style="height: 32px; width: auto; margin-left: 8px; vertical-align: middle;" />
        </span>
      </div>
    </ng-container>
  </ng-container>
</ng-container>
<!-- Error Modal for game not existing -->
<div class="custom-modal-overlay" *ngIf="showErrorModal">
  <div class="custom-modal">
    <div class="custom-modal-title">Game Not Found</div>
    <div class="custom-modal-message">{{ errorModalMessage }}</div>
    <div class="custom-modal-actions">
      <button class="modal-btn confirm" (click)="onAcknowledgeError()">OK</button>
    </div>
  </div>
</div>
<!-- Custom Confirmation Modal -->
<div class="custom-modal-overlay" *ngIf="showConfirmModal">
  <div class="custom-modal">
    <div class="custom-modal-title">{{ confirmTitle }}</div>
    <div class="custom-modal-message">{{ confirmMessage }}</div>
    <div class="custom-modal-actions">
      <ng-container *ngIf="arrangedFullPlayers.length === 2">
        <button class="modal-btn confirm" (click)="onEndGameFromModal()">End Game</button>
        <button class="modal-btn cancel" (click)="onCancelLeave()">Cancel</button>
      </ng-container>
      <ng-container *ngIf="arrangedFullPlayers.length !== 2">
        <ng-container *ngIf="isAdmin; else playerConfirmBtns">
          <button class="modal-btn confirm" (click)="onEndGameFromModal()">End Game</button>
          <button class="modal-btn confirm" (click)="onLeaveGameFromModal()">Leave Game</button>
          <button class="modal-btn cancel" (click)="onCancelLeave()">Cancel</button>
        </ng-container>
        <ng-template #playerConfirmBtns>
          <button class="modal-btn confirm" (click)="onConfirmLeave()">Yes</button>
          <button class="modal-btn cancel" (click)="onCancelLeave()">No</button>
        </ng-template>
      </ng-container>
    </div>
  </div>
</div>

<!-- Game Ended Modal -->
<div class="custom-modal-overlay" *ngIf="showGameEndedModal">
  <div class="custom-modal">
    <div class="custom-modal-title">Game Ended</div>
    <div class="custom-modal-message">This game has ended. You will be redirected to the home page.</div>
    <div class="custom-modal-actions">
      <button class="modal-btn confirm" (click)="onAcknowledgeGameEnded()">OK</button>
    </div>
  </div>
</div>
<!-- Animated card image overlay -->
<img *ngIf="showCardAnimation" #animatedCard class="animated-card-image" [src]="animatedCardUrl"
  [ngStyle]="animatedCardStyle" />
<!-- Winner card transfer animation layer -->
<div class="winner-card-anim-layer">
  <img *ngFor="let c of winnerCardAnimations" class="winner-fly-card" [src]="c.imageUrl" [ngStyle]="{
      left: c.x + 'px',
      top: c.y + 'px',
      transform: 'translate(-50%, -50%)'
    }" />
</div>
<div class="game-table-container">
  <!-- Sticker animation overlay -->
  <div class="sticker-anim-overlay">
    <div *ngFor="let sticker of stickerAnimations" class="sticker-anim-item">
      <div class="sticker-anim-username">{{sticker.userName}}</div>
      <img [src]="sticker.imageUrl" [alt]="sticker.name" class="sticker-anim-img" />
      <div *ngIf="sticker.message" class="sticker-anim-message">{{sticker.message}}</div>
    </div>
  </div>
  <!-- Top controls -->
  <div class="top-controls">
    <button *ngIf="arrangedFullPlayers.length != 2" class="leave-btn" (click)="onLeaveOrEndGameClick('leave')">Leave
      Game</button>
    <button *ngIf="isAdmin || arrangedFullPlayers.length === 2" class="delete-btn"
      (click)="onLeaveOrEndGameClick('end')">End Game</button>
  </div>

  <!-- Spinner for game start -->
  <div *ngIf="!currentStatSelector" class="spinner">
    <div class="spinner-graphic"></div>
    <div class="spinner-label">Selecting first player...</div>
  </div>

  <!-- Table layout -->
  <div class="table">
    <!-- Player seats arranged in a circle -->
    <ng-container *ngIf="arrangedFullPlayers.length > 0; else noPlayers">
      <ng-container *ngFor="let player of arrangedFullPlayers; let i = index">
        <div *ngIf="player" class="player-seat" [ngClass]="{'me': player.isMe}"
          [ngStyle]="getCircularSeatStyle(i, arrangedFullPlayers.length)">
          <div
            [ngClass]="{'disabled': (myUsername === player.username && myCards.length === 0) || !currentroundplayers.includes(player.username)}">

            <img
              [src]="(player.profilePicUrl !== null && player.profilePicUrl !== undefined && player.profilePicUrl !== '') ? player.profilePicUrl : 'https://ui-avatars.com/api/?name=' + (player.username || 'Player') + '&background=random'"
              [alt]="player.username || player.id" class="player-avatar"
              [ngClass]="{'stat-selector-avatar': player.id?.toString() === currentStatSelector}" />
            <div class="username">{{this.myUsername==player.username?"you":player.username }}</div>
          </div>


        </div>
      </ng-container>
    </ng-container>
    <ng-template #noPlayers>
      <div style="color: var(--blue-1); text-align: center; font-weight: bold; margin-top: 40px;">
        Loading players...
        <div class="spinner" style="margin: 20px auto 0; width: 40px; height: 40px;"></div>
      </div>
    </ng-template>
    <!-- Game Table center: Winner/Tie display overlay -->
    <div class="table-center-overlay" *ngIf="winner || isTie"
      style="position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); z-index: 10; display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; pointer-events: none; ">
      <div class="center-result"
        style="display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center;">
        <ng-container *ngIf="winner && !isTie">
          <div class="center-label winner-label username"
            style="margin-bottom: 0.5em; text-align: center; color: var(--success);">{{winnerUsername === myUsername ?
            'You' : winnerUsername || 'winner'}}</div>
          <div class="center-profiles"
            style="display: flex; flex-direction: row; align-items: center; justify-content: center; gap: 1.5em;">
            <ng-container *ngFor="let p of arrangedFullPlayers">
              <ng-container *ngIf="winner===p.id">
                <div style="display: flex; flex-direction: column; align-items: center;">
                  <img
                    [src]="(p.profilePicUrl !== null && p.profilePicUrl !== undefined && p.profilePicUrl !== '') ? p.profilePicUrl : 'https://ui-avatars.com/api/?name=' + (p.username || 'Player') + '&background=random'"
                    [alt]="p.username || p.id" class="player-avatar center-profile-avatar"
                    style="margin-bottom: 0.25em;" />
                  <div class="username">{{p.username === myUsername ? 'You' : p.username}}</div>
                </div>
              </ng-container>
            </ng-container>
          </div>
        </ng-container>
        <ng-container *ngIf="isTie && !winner">
          <div class="center-label tie-label username"
            style="margin-bottom: 0.5em; text-align: center; color: var(--tie);">Tie</div>
          <div class="center-profiles"
            style="display: flex; flex-direction: row; align-items: center; justify-content: center; gap: 1.5em;">
            <ng-container *ngFor="let p of arrangedFullPlayers">
              <ng-container *ngIf="currentroundplayers.includes(p.username)">
                <div style="display: flex; flex-direction: column; align-items: center;">
                  <img
                    [src]="(p.profilePicUrl !== null && p.profilePicUrl !== undefined && p.profilePicUrl !== '') ? p.profilePicUrl : 'https://ui-avatars.com/api/?name=' + (p.username || 'Player') + '&background=random'"
                    [alt]="p.username || p.id" class="player-avatar center-profile-avatar"
                    style="margin-bottom: 0.25em;" />
                  <div class="username">{{p.username === myUsername ? 'You' : p.username}}</div>
                </div>
              </ng-container>
            </ng-container>
          </div>
        </ng-container>
      </div>
    </div>
  </div>

  <!-- Bottom bar: cards and messaging -->
  <div class="bottom-bar">
    <span class="cards-count">Cards: {{myCards.length}}</span>
    <button [disabled]="!myCards || myCards.length === 0" class="game-action-btn cards-btn"
      (click)="showCardList = true">Cards</button>
    <button [disabled]="!myCards || myCards.length === 0" class="game-action-btn next-card-btn"
      (click)="showNextCard()">Next Card</button>
    <!-- Old message button (to be removed after migration) -->
    <button class="game-action-btn message-btn" (click)="displayStickers()">ðŸ’¬</button>
    <!-- Floating Chat Button -->

    <!-- Floating Chat Panel -->
    
  </div>
  <!-- Stickers panel overlay -->
  <div class="stickers-panel-overlay" *ngIf="showStickersPanel">
    <div class="stickers-panel">
      <button class="close-btn sticky-close-btn" (click)="closeStickersPanel()">âœ–</button>
      <!-- Chat history inside sticker panel -->
      <div *ngIf="!showStickerPicker" class="chat-history-in-sticker-panel">
        <div *ngIf="chatMessages.length === 0" class="chat-empty">No messages yet.</div>
        <div #chatScrollTop></div>
        <div *ngFor="let msg of chatMessages" class="chat-message-row"
          [ngClass]="{'own-message': msg.senderUsername === myUsername}">
          <div class="chat-message-avatar" style="display: flex; flex-direction: column; align-items: center;">
            <img [src]="getUserAvatar(msg.senderUsername)" [alt]="msg.senderUsername" />
            <span class="chat-message-username" style="width: 36px; font-size: 9px; text-align: center;         /* your specific width */
  word-wrap: break-word;
  overflow-wrap: anywhere;
  white-space: normal; ">{{ msg.senderUsername === myUsername ? '' : msg.senderUsername }}</span>
          </div>
          <div class="chat-message-content">
            <div class="chat-message-text" *ngIf="msg.message" style="display: inline-block; width: auto; min-width: unset; max-width: 100%; padding: 0; margin: 0; text-align: center;">{{ msg.message }}</div>
            <div class="chat-message-sticker" *ngIf="msg.stickerUrl">
              <img [src]="msg.stickerUrl" alt="sticker" />
            </div>
          </div>
        </div>
        <div #chatEnd></div>
      </div>
      <!-- STICKER PICKER VIEW -->
      <div class="sticker-picker-popup" *ngIf="showStickerPicker">
        
        <input type="text" class="sticker-search" [(ngModel)]="stickerSearch"
          placeholder="Search stickers by name..." />
        <div class="stickers-grid">
          <div *ngFor="let sticker of filteredStickers" class="sticker-item"
            [class.selected-sticker]="selectedStickerId === sticker.id" (click)="selectSticker(sticker.id)">
            <img [src]="sticker.imageUrl" [alt]="sticker.name" class="sticker-img" />
            <span class="sticker-name">{{ sticker.name }}</span>
            <span *ngIf="selectedStickerId === sticker.id" class="tick-mark">
              <svg viewBox="0 0 20 20">
                <polyline points="5 11 9 15 15 7" stroke="white" stroke-width="2" fill="none" />
              </svg>
            </span>
          </div>
        </div>
      </div>

      <!-- Sticker recipients and sticker picker button in one row -->
      <div class="sticker-panel-top-row"
        style="display: flex; justify-content: center; align-items: center; gap: 8px; padding: 1rem;">
        <div class="sticker-recipients-row"
          style="display: flex; flex-wrap: wrap; gap: 8px; align-items: center; justify-content: center;">
          <!-- Select All -->
          <label *ngIf="usernames.length > 1" [class.selected-checkbox]="isAllSelected"
            [class.unselected-checkbox]="!isAllSelected">
            <input type="checkbox" [checked]="isAllSelected" (change)="toggleAll($event)" />
            All
          </label>

          <!-- Individual Players -->
          <label *ngFor="let username of usernames"
            [class.selected-checkbox]="stickerRecipient.includes(username) && !isAllSelected"
            [class.unselected-checkbox]="!stickerRecipient.includes(username) || isAllSelected">
            <input type="checkbox" [checked]="stickerRecipient.includes(username)"
              (change)="togglePlayer(username, ($event))" class="recipient-checkbox" />
            {{username }}
          </label>
        </div>
        <button class="open-sticker-picker-btn" style="margin-left: auto;"
          (click)="showStickerPicker = !showStickerPicker" [attr.aria-label]="showStickerPicker ? 'Show chat' : 'Show stickers'">
  <ng-container *ngIf="!showStickerPicker; else chatIcon">
    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" class="bi bi-sticky" viewBox="0 0 16 16">
      <path d="M2.5 1A1.5 1.5 0 0 0 1 2.5v11A1.5 1.5 0 0 0 2.5 15h6.086a1.5 1.5 0 0 0 1.06-.44l4.915-4.914A1.5 1.5 0 0 0 15 8.586V2.5A1.5 1.5 0 0 0 13.5 1zM2 2.5a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 .5.5V8H9.5A1.5 1.5 0 0 0 8 9.5V14H2.5a.5.5 0 0 1-.5-.5zm7 11.293V9.5a.5.5 0 0 1 .5-.5h4.293z" />
    </svg>
  </ng-container>
  <ng-template #chatIcon>
    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" class="bi bi-chat" viewBox="0 0 16 16">
      <path d="M2.678 11.894a1 1 0 0 1 .287.801 11 11 0 0 1-.398 2c1.395-.323 2.247-.697 2.634-.893a1 1 0 0 1 .71-.074A8 8 0 0 0 8 14c3.996 0 7-2.807 7-6s-3.004-6-7-6-7 2.808-7 6c0 1.468.617 2.83 1.678 3.894m-.493 3.905a22 22 0 0 1-.713.129c-.2.032-.352-.176-.273-.362a10 10 0 0 0 .244-.637l.003-.01c.248-.72.45-1.548.524-2.319C.743 11.37 0 9.76 0 8c0-3.866 3.582-7 8-7s8 3.134 8 7-3.582 7-8 7a9 9 0 0 1-2.347-.306c-.52.263-1.639.742-3.468 1.105"/>
    </svg>
  </ng-template>
</button>
      </div>
      <!-- Message input and send button in one row below -->
      <div class="sticker-panel-bottom-row"
        style="display: flex; align-items: center; gap: 8px;  justify-content: center; flex-direction: row;">
        <input type="text" class="sticker-message-input ng-untouched ng-pristine ng-valid" [(ngModel)]="message"
          placeholder="Enter a message (optional)" />
        <button class="send-sticker-btn" (click)="sendSticker(selectedStickerId, message)"
          [disabled]="stickerRecipient.length === 0 || (!selectedStickerId && !message)">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-send"
            viewBox="0 0 16 16">
            <path
              d="M15.854.146a.5.5 0 0 1 .11.54l-5.819 14.547a.75.75 0 0 1-1.329.124l-3.178-4.995L.643 7.184a.75.75 0 0 1 .124-1.33L15.314.037a.5.5 0 0 1 .54.11ZM6.636 10.07l2.761 4.338L14.13 2.576zm6.787-8.201L1.591 6.602l4.339 2.76z" />
          </svg>
        </button>
      </div>
    </div>
  </div>

  <!-- Floating previous-round-cards toggle button (bottom-right, above bottom bar) -->
  <button class="floating-prev-round-btn" (click)="togglePreviousRoundCards()">Previous Round Cards</button>

  <!-- Previous round cards sliding panel -->
  <div class="prev-round-panel" [class.open]="showPreviousRoundCards">
    <div class="prev-panel-header">
      <h3>Previous Round Cards</h3>
      <button class="close-panel" (click)="togglePreviousRoundCards()">âœ–</button>
    </div>
    <div class="prev-cards-list detailed-prev-cards-list">
      <div *ngIf="!previousRoundCards?.length" class="empty">No previous round cards available.</div>
      <ng-container *ngFor="let round of getGroupedRounds()">
        <!-- One summary bar per round -->
        <div class="round-summary-bar compact">
          <span class="round-label">R{{round.roundnumber}}</span>
          <ng-container *ngIf="round.winner; else tieBlock">
            <span class="player-badge winner-player">{{round.winner === myUsername ? 'You' : round.winner}}<span
                class="badge-count">+{{round.winnerCount}}</span></span>
            <ng-container *ngFor="let loser of round.losers">
              <span class="player-badge loser-player">{{loser.userName === myUsername ? 'You' : loser.userName}}<span
                  class="badge-count">-{{loser.count}}</span></span>
            </ng-container>
          </ng-container>
          <ng-template #tieBlock>
            <ng-container *ngFor="let tie of round.tiePlayers">
              <span class="player-badge tie-player">{{tie.userName === myUsername ? 'You' : tie.userName}}<span
                  class="badge-count">-{{tie.count}}</span></span>
            </ng-container>
            <ng-container *ngFor="let loser of round.losers">
              <span class="player-badge loser-player">{{loser.userName === myUsername ? 'You' : loser.userName}}<span
                  class="badge-count">-{{loser.count}}</span></span>
            </ng-container>
          </ng-template>
        </div>
        <!-- All cards for this round -->
        <ng-container *ngFor="let card of round.cards">
          <div class="detailed-prev-card-item">
            <div class="detailed-prev-card">
              <div class="detailed-prev-username" [ngClass]="{
                  'winner-card': card.winner === (card.userName || card.username),
                  'tie-card': card.tiePlayersWinners && card.tiePlayersWinners.includes(card.userName || card.username)
                }">
                {{(card.userName || card.username) === myUsername ? 'You' : (card.userName || card.username)}}
              </div>
              <div class="detailed-prev-card-content">
                <div class="detailed-prev-card-image">
                  <img [src]="card.picture || card.imageUrl" [alt]="card.name || card.title" />
                </div>
                <div class="detailed-prev-card-stats">
                  <div *ngFor="let stat of getPrevCardStats(card)" class="detailed-prev-card-stat"
                    [ngClass]="{'selected-stat-row': isSelectedStat(card, stat)}">
                    <span class="stat-label">{{stat.label}}</span> <span class="stat-value">{{stat.value}}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </ng-container>
      </ng-container>
    </div>
  </div>

  <!-- Card list overlay (kept in DOM for smooth close animation) -->
   
  <div class="card-list" [class.open]="showCardList" [attr.aria-hidden]="!showCardList">
    <button class="close-btn card-list-close" (click)="showCardList = false">
    âœ–
  </button>
    <div class="card-grid">
      <div *ngFor="let card of myCards" class="card-item" (click)="showCardDetails(card)">
        <img [src]="card.picture || card.imageUrl" [alt]="card.title" class="card-image-thumb" />
        <div class="card-title" style="color: var(--text-1);">{{card.title}}</div>
      </div>
    </div>
    
  </div>

  <!-- Top card overlay (kept in DOM for animation) -->
  <div class="top-card-overlay" [class.open]="topCard && showTopCard" [attr.aria-hidden]="!(topCard && showTopCard)">
    <div class="top-card">
      <button class="close-btn" (click)="closeCardDetails()">âœ–</button>
      <div class="card-details-image">
        <img [src]="topCard?.picture || topCard?.imageUrl" [alt]="topCard?.title" class="top-card-image" />
      </div>
      <div class="card-title" style="color: var(--text-1);">{{topCard?.title}}</div>
      <div *ngIf="topCard?.description" class="card-description">{{topCard.description}}</div>

      <div class="card-details-info">
        <div *ngFor="let stat of statList" class="stat-card"
          [ngClass]="{'selectable': currentStatSelector === myUserId, 'selected-stat': selectedStat === stat.key}"
          (click)="currentStatSelector === myUserId ? selectStat(stat.key) : null">
          <span class="stat-label">{{stat.label}}</span>
          <span class="stat-value">{{stat.value}}</span>
        </div>

        <div style="display:flex; justify-content:flex-end; width:100%;">
          <button *ngIf="currentStatSelector === myUserId" class="select-card-btn"
            (click)="submitStatSelection()">Select</button>
          <button *ngIf="currentStatSelector !== myUserId" class="select-card-btn-disabled" disabled>Select</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Selected card overlay (kept in DOM for animation) -->
  <div class="top-card-overlay" [class.open]="selectedCard && (!topCard || selectedCard.id !== topCard.id)"
    [attr.aria-hidden]="!(selectedCard && (!topCard || selectedCard.id !== topCard.id))">
    <div class="top-card">
      <button class="close-btn" (click)="closeCardDetails()">âœ–</button>
      <div class="card-details-image">
        <img [src]="selectedCard?.picture || selectedCard?.imageUrl" [alt]="selectedCard?.title"
          class="card-image-thumb top-card-image not-top-card-image" />
      </div>
      <div class="card-title" style="color: var(--text-1);">{{selectedCard?.title}}</div>
      <div *ngIf="selectedCard?.description" class="card-description">{{selectedCard.description}}</div>

      <div class="card-details-info">
        <div *ngFor="let stat of getStatList(selectedCard)" class="stat-card"
          [ngClass]="{'selected-stat-row': isSelectedStat(selectedCard, stat)}">
          <span class="stat-label">{{stat.label}}</span>
          <span class="stat-value">{{stat.value}}</span>
        </div>
      </div>
    </div>
  </div>
</div>